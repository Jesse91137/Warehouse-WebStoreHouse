@{
    Layout = "~/Views/Shared/_LayoutMember.cshtml";
}
@using PagedList
@using PagedList.Mvc
@model IPagedList<WebStoreHouse.Models.StoreHouseStock>
@{
    ViewBag.Title = "倉庫庫存";
}
<p></p>

<h2>倉庫庫存</h2>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-warning" style="margin-bottom:20px;">
        @TempData["ErrorMessage"]
    </div>
}

<p>
    @if (@ViewBag.RoleId != "V")
    {
        @Html.ActionLink("建立新資料", "StockCreate", null, new { @class = "btn btn-primary" })
    }
</p>

<head>
    <script src="~/Scripts/jquery-3.4.1.min.js"></script>
    <link href="~/Content/bootstrap.css" rel="stylesheet" />
    <link href="~/Content/PagedList.css" rel="stylesheet" />
    <link href="~/Content/position-sticky.css" rel="stylesheet" />
    <style>
        .table-sticky thead th {
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            word-break: normal;
            padding: 8px 12px;
            width: auto;
        }

        .table-sticky td {
            word-break: break-all;
            white-space: normal;
        }
    </style>
    <script>
        $(document).ready(function () {
            // 查詢
            $('#detailBtn').click(function () {
                var key = $('#detailBtn').data('id');
                $.ajax({
                    url: '@Url.Action("StoreHouseStockDetails", "Function")',
                    type: 'GET',
                    data: { 'id': key },
                    success: function (data) {
                        $('#myModal .modal-body').html(data);
                        $('#myModal').modal('show');
                    }
                });
            });

            // 匯出 Excel 按鈕
            $('#btnExport').click(function () {
                try {
                    var wono = $('#wono').val();
                    var order_cust = $('#order_cust').val();
                    var engsr = $('#engsr').val();
                    var inputdate_start = $('#inputdate_start').val();
                    var inputdate_end = $('#inputdate_end').val();
                    var url = '@Url.Action("ExportStoreHouseStock", "Function")';
                    var params = [];
                    if (wono) params.push('wono=' + encodeURIComponent(wono));
                    if (order_cust) params.push('order_cust=' + encodeURIComponent(order_cust));
                    if (engsr) params.push('engsr=' + encodeURIComponent(engsr));
                    if (inputdate_start) params.push('inputdate_start=' + encodeURIComponent(inputdate_start));
                    if (inputdate_end) params.push('inputdate_end=' + encodeURIComponent(inputdate_end));
                    if (params.length > 0) url += '?' + params.join('&');

                    // AJAX 下載 Excel
                    $.ajax({
                        url: url,
                        type: 'GET',
                        xhrFields: { responseType: 'blob' },
                        success: function (data, status, xhr) {
                            try {
                                var contentType = xhr.getResponseHeader('Content-Type');
                                var disposition = xhr.getResponseHeader('Content-Disposition');
                                var filename = '庫存匯出.xlsx'; // 預設檔名
                                // 先解析 filename* (RFC 5987)
                                if (disposition) {
                                    var matchesStar = disposition.match(/filename\*=UTF-8''([^;\n]*)/);
                                    if (matchesStar && matchesStar[1]) {
                                        filename = decodeURIComponent(matchesStar[1]);
                                    } else {
                                        // 再解析 filename
                                        var matches = disposition.match(/filename="?([^";\n]+)"?/);
                                        if (matches && matches[1]) {
                                            filename = matches[1];
                                        }
                                    }
                                }

                                if (contentType && contentType.indexOf('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') !== -1) {
                                    var blob = new Blob([data], { type: contentType });
                                    var link = document.createElement('a');
                                    link.href = window.URL.createObjectURL(blob);
                                    link.download = filename;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                } else {
                                    // 讀取錯誤訊息內容
                                    var reader = new FileReader();
                                    reader.onload = function () {
                                        alert(reader.result || '匯出失敗，請確認登入或查詢條件。');
                                    };
                                    reader.readAsText(data);
                                }
                            } catch (e) {
                                alert('匯出處理失敗：' + e.message);
                            }
                        },
                        error: function (xhr) {
                            alert('匯出失敗：' + xhr.statusText);
                        }
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        alert('匯出 AJAX 失敗：' + textStatus + ' ' + errorThrown);
                    });
                } catch (ex) {
                    alert('匯出 Excel 發生例外：' + ex.message);
                }
            });
        });
    </script>

</head>
@using (Html.BeginForm())
{
    @Html.PagedListPager(Model, page => Url.Action("StoreHouseStock", new
    {
        page,
wono = ViewBag.wono,
order_cust = ViewBag.order_cust,
engsr = ViewBag.engsr,
inputdate_start = ViewBag.inputdate_start,
inputdate_end = ViewBag.inputdate_end
}))
    <label for="wono">工單號碼:</label>

    @Html.TextBox("wono", ViewBag.wono as string, new
{
    @class = "form-control input-sm",
    @id = "wono",
    @placeholder =
    "請輸入工單號碼",
    style = "display:inline-block; width: 150px; margin-right:10px;"
})
    <label for="order_cust">客戶業單:</label>

    @Html.TextBox("order_cust", ViewBag.order_cust as string, new
{
    @class = "form-control input-sm",
    @id = "order_cust",
    @placeholder = "請輸入客戶業單",
    style = "display:inline-block; width: 150px; margin-right:10px;"
})
    <label for="engsr">機種名稱:</label>

    @Html.TextBox("engsr", ViewBag.engsr as string, new
{
    @class = "form-control input-sm",
    @id = "engsr",
    @placeholder =
    "請輸入機種名稱",
    style = "display:inline-block; width: 150px; margin-right:10px;"
})
    <label for="inputdate_start">入庫日期:</label>
    <input type="text" id="inputdate_start" name="inputdate_start" class="form-control input-sm" placeholder="YYYY-MM-DD"
           style="display:inline-block; width: 90px;" value="@ViewBag.inputdate_start" />
    <label for="inputdate_end">至</label>
    <input type="text" id="inputdate_end" name="inputdate_end" class="form-control input-sm" placeholder="YYYY-MM-DD"
           style="display: inline-block; width: 90px; margin-right: 10px;" value="@ViewBag.inputdate_end" />
    <button type="submit" class="btn btn-warning" style="width: 90px; margin-right: 10px;">查詢</button>
    <button type="button" class="btn btn-success" id="btnExport" style="width: 90px; margin-right: 10px;">匯出</button>

}
<p></p>
<table class=" table table-sticky" style="width:100%;">
    <thead class="tr-sticky">
        <tr>
            <th style="width: 120px;">工單</th>
            <th style="width: 110px;">客戶業單</th>
            <th style="width: 110px;">機種名稱</th>
            <th style="width: 90px;">訂單數量</th>
            <th style="width: 70px;">箱數</th>
            <th style="width: 70px;">數量</th>
            <th style="width: 70px;">KF10</th>
            <th style="width: 70px;">KQ30</th>
            <th style="width: 90px;">儲位</th>
            <th style="width: 90px;">累積入庫</th>
            <th style="width: 120px;">預計銷單日</th>
            <th style="width: 90px;">備註</th>
            <th style="width: 110px;">入庫日期</th>
            <th style="width: 70px;">包裝</th>
            @if (ViewBag.RoleId != "V")
            {
                <th style="width: 65px;"></th>
            }
            @if (@ViewBag.RoleId == "A")
            {
                <th style="width: 65px;"></th>
            }
        </tr>
    </thead>
    @foreach (var item in Model)
    {
        <tr class="@((item.nowono == "Y") ? "empty-row" : "")">
            <td>
                @Html.DisplayFor(modelItem => item.wono)
                @if (!string.IsNullOrEmpty(item.Igroup))
                {
                    <button id="detailBtn" data-id=@item.Igroup>展開</button>
                }
            </td>
            <td>@Html.DisplayFor(modelItem => item.cust_wono)</td>
            <td>@Html.DisplayFor(modelItem => item.eng_sr)</td>
            <td>@Html.DisplayFor(modelItem => item.order_count)</td>
            <td>@Html.DisplayFor(modelItem => item.box_quantity)</td>
            <td>@Html.DisplayFor(modelItem => item.quantity)</td>
            <td>@Html.DisplayFor(modelItem => item.kf10)</td>
            <td>@Html.DisplayFor(modelItem => item.kq30)</td>
            <td>@Html.DisplayFor(modelItem => item.position)</td>
            <td>@Html.DisplayFor(modelItem => item.acc_in)</td>
            <td>@DateTime.Parse(item.due_date.ToString()).ToShortDateString()</td>
            <td>@Html.DisplayFor(modelItem => item.mark)</td>
            <td>@Html.DisplayFor(modelItem => item.inputdate)</td>
            <td>@Html.DisplayFor(modelItem => item.package)</td>
            @if (@ViewBag.RoleId != "V")
            {
                <td>
                    @Html.ActionLink("編輯", "EditStock", new { serialno = item.serialno }, new { @class = "btn btn-warning" })
                </td>
            }
            @if (@ViewBag.RoleId == "A")
            {
                <td>
                    @if (!string.IsNullOrEmpty(item.Igroup))
                    {
                        @Html.ActionLink("刪除", "DeleteStock", new { igroup = item.Igroup }, new { @class = "btn btn-danger" })
                    }
                    else
                    {
                        @Html.ActionLink("刪除", "DeleteStock", new { serialno = item.serialno }, new { @class = "btn btn-danger" })
                    }
                </td>
            }
        </tr>
    }
</table>
@Html.PagedListPager(Model, page => Url.Action("StoreHouseStock", new
{
    page,
wono = ViewBag.wono,
order_cust = ViewBag.order_cust,
engsr = ViewBag.engsr,
inputdate_start = ViewBag.inputdate_start,
inputdate_end = ViewBag.inputdate_end
}))
<div id="myModal" class="modal fade">
    <div class="modal-dialog" style="width: 100%; ">
        <div class=" modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">群組資料明細</h4>
            </div>
            <div class="modal-body">
                <!-- 在這裡顯示詳細資訊 -->
            </div>
        </div>
    </div>
</div>
