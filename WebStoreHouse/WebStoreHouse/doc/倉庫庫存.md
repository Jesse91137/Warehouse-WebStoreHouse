
title: StoreHouseStock 操作邏輯規格

## 每日排程"\\192.168.4.11\33 倉庫備料單\07. 收發組\成倉\成倉SAP_Excel\"把EXCEL檔案
- [ZRSD19] 取得寫入 E_ZRSD19
- [ZRSD14P] 取得寫入 E_ZRSD14P
- [KQ30] 取得寫入 E_KQ30
- [KF10] 取得寫入 E_Kf10

## 1. 新增倉庫庫存模組說明
1.1.流程概述
- 1.1.新增
- 1.2.檢查E_ZRSD19 / E_ZRSD14P 工單是否存在，若不存在View顯示無法新增庫存
- 1.3.檢查E_ZRSD19 / E_ZRSD14P 工單存在
- 無業單號新增-勾選[無業單號新增]
- 有業單號新增-[群組]=![Group]及未勾選[無業單號新增]
- 1.寫入"入庫存表"[E_StoreHouseStock_In]
- 2.分別查詢-[ZRSD19]-"db.E_ZRSD19.FirstOrDefault(o => o.wono == wono)"或"db.E_ZRSD14P.FirstOrDefault(o => o.wono == wono)"，如有查到再進一步查詢" var query = from a in db.E_ZRSD19
             join b in (from E_Kf10 in db.E_Kf10 group E_Kf10 by E_Kf10.Material into g select new { Material = g.Key, Unrestricted = (int?)g.Sum(p => p.Unrestricted) })
                 on a.item equals b.Material into b_join
             from b in b_join.DefaultIfEmpty()
             join c in (from E_KQ30 in db.E_KQ30 group E_KQ30 by E_KQ30.Material into g select new { Material = g.Key, Unrestricted = (int?)g.Sum(p => p.Unrestricted) })
                 on a.item equals c.Material into c_join
             from c in c_join.DefaultIfEmpty()
             where a.wono == wono
             select new
             {
                 a.wono_cust,
                 a.item,
                 a.order_quantity,
                 kf10 = b.Unrestricted ?? 0,
                 kq30 = c.Unrestricted ?? 0,
                 a.wono_inStoreCount,
                 a.shipped_quantity,
                 a.unshipped_quantity,
                 a.borrow_count,
                 a.due_date,
             }"
-[ZRSD14P]-"var chk_in = db.E_StoreHouseStock_In.Where(_in => _in.wono == wono).OrderByDescending(_in => _in.sno).FirstOrDefault();"			 
3.查詢[庫存總表][E_StoreHouseStock]-"var stockCount = db.E_StoreHouseStock.Where(stock => stock.wono == wono && stock.position == position && stock.del_flag != "D");"如果有資料則更新庫存數量，沒有資料則新增庫存資料

2.修改-[庫存總表]"E_StoreHouseStock"-只能修改[儲位]和[備註]，當[儲位]修改時，查詢條件"db.E_StoreHouseStock
                .Where(s => s.wono == wono && s.position == position && s.del_flag != "D").FirstOrDefault()"，如有查詢到則更新數量，會將原本的資料[備註]新增"轉庫位"的紀錄，並將原本的資料[del_flag]更新為"D"及數量更新為"0"，以避免搜尋出現，
3.刪除-[庫存總表]"E_StoreHouseStock"-當刪除時，若有指定群組，則刪除該群組下所有庫存資料，否則僅刪除指定 serialno 的單筆庫存資料，會將[del_flag]更新為"D"。
