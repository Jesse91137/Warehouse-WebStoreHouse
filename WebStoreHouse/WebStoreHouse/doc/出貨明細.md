
- 刪除出貨訂單，並將庫存數量加回[庫存總表]"E_StoreHouseStock"
---
title: "StoreHouseStock_Order 出貨明細操作規格 (clean)"
version: 1.0
date_created: 2025-11-13
last_updated: 2025-11-13
owner: WebStoreHouse Team
tags:
	- process
	- specification
	- stock
	- order
---
---

StoreHouseStock_Order 操作規格（乾淨版）
======================================

本文檔定義 StoreHouseStock_Order 的操作規格，包含資料契約、流程、交易與鎖定策略、錯誤處理、驗收條件與測試建議。

目的與範圍
--------

- 目的：對出貨訂單執行庫存分配與扣減，產生 ShipmentDetail，並保證資料的一致性與可追溯性。
- 範圍：覆蓋分配、預扣、實扣、回滾、事件發佈、日誌與監控需求。

定義
----

- StoreHouseStock_Order：出貨分配操作。
- OrderLine：包含 sku、quantity、warehouseId、noSplit、attributes 等欄位。
- StockItem：倉庫中 SKU 的庫存紀錄（含 total、reserved、locked、batch 等）。
- Reservation：預扣紀錄。
- ShipmentDetail：實際扣減之紀錄。

要求與限制
----------

- **REQ-001**：檢查並確保所有 OrderLine 可用庫存足夠。
- **REQ-002**：扣庫存操作必須在單一資料庫交易中執行；任一失敗應回滾。
- **REQ-003**：支援部分/全數出貨；若 `noSplit=true`，則禁止部分出貨。
- **REQ-004**：建立 ShipmentDetail，記錄來源庫位、批號（如適用）、數量、時間與操作人。
- **REQ-005**：採用鎖定策略避免超賣（悲觀或樂觀鎖）。

輸入 / 輸出 資料契約
------------------

Request (StoreHouseStock_OrderRequest)
-------------------------------------

- `orderId`: string
- `operatorId?`: string
- `reservationOnly?`: boolean
- `lines`: array of
  - `lineId`: string
  - `sku`: string
  - `quantity`: integer
  - `warehouseId?`: string
  - `noSplit?`: boolean
  - `attributes?`: object

Response (StoreHouseStock_OrderResponse)
---------------------------------------

- `success`: boolean
- `orderId`: string
- `results`: array of
  - `lineId`: string
  - `allocated`: integer
  - `allocatedFrom`: array of { warehouseId, locationId?, batchNo?, quantity }
  - `status`: string
  - `reason?`: string
- `errorCode?`: string
- `errorMessage?`: string

流程（高階）
------------

1. 驗證輸入欄位與資料型態。
2. 依倉別與分配策略讀取 candidate StockItem(s)。
3. 計算可用庫存（available = total - reserved - locked）。
4. 在資料庫交易內鎖定並分配：
   - 若 `reservationOnly`，則增加 `reserved`。
   - 否則更新 on-hand 與 reserved，並建立 ShipmentDetail。
5. 若所有分配成功則 commit，否則 rollback 並回報錯誤。
6. 發佈事件並寫入操作日誌。

交易與鎖定策略
------------

- 建議在熱點 SKU 使用悲觀鎖（SELECT ... FOR UPDATE），其他情境採樂觀鎖並實作重試機制。
- 鎖定與交易超時應可配置（例如 5 秒）並在超時時回報 TRANSACTION_TIMEOUT。

錯誤代碼（範例）
---------------

- `STOCK_INSUFFICIENT`
- `LOCK_FAILED`
- `VALIDATION_ERROR`
- `TRANSACTION_TIMEOUT`
- `PARTIAL_ALLOCATION_NOT_ALLOWED`

Acceptance Criteria（概要）
-------------------------

- AC-001：正常情況下產生 ShipmentDetail 並回傳 success。
- AC-002：庫存不足時，依 `noSplit` 行為回報 PartialAllocated 或失敗。
- AC-003：任一分配失敗時，整筆交易回滾。
- AC-004：`reservationOnly` 模式僅改變 reserved，不變更 total。

測試建議
--------

- 單元測試：驗證分配邏輯與錯誤處理。
- 整合測試：使用測試資料庫模擬鎖定衝突與重試。
- E2E 測試：模擬高併發情境與補償流程。

範例（JSON）
----------

Request 範例：

```json
{
  "orderId": "ORD-20251113-0001",
  "operatorId": "system",
  "lines": [
    { "lineId": "L1", "sku": "SKU-AAA", "quantity": 5, "warehouseId": "WH-01" },
    { "lineId": "L2", "sku": "SKU-BBB", "quantity": 2 }
  ]
}
```

Response 範例（成功）：

```json
{
  "success": true,
  "orderId": "ORD-20251113-0001",
  "results": [
    { "lineId": "L1", "allocated": 5, "allocatedFrom": [{ "warehouseId":"WH-01","quantity":5 }], "status": "Allocated" },
    { "lineId": "L2", "allocated": 2, "allocatedFrom": [{ "warehouseId":"WH-02","quantity":2 }], "status": "Allocated" }
  ]
}
```
title: "StoreHouseStock_Order 出貨明細操作規格 (clean)"
version: 1.0
date_created: 2025-11-13
last_updated: 2025-11-13
owner: WebStoreHouse Team
	- process
	- specification
	- stock
	- order
---

# StoreHouseStock_Order 操作規格（乾淨版）

本文檔定義 StoreHouseStock_Order 的操作規格，包含資料契約、流程、交易與鎖定策略、錯誤處理、驗收條件與測試建議。


StoreHouseStock_Order 操作規格（乾淨版）
======================================

本文檔定義 StoreHouseStock_Order 的操作規格，包含資料契約、流程、交易與鎖定策略、錯誤處理、驗收條件與測試建議。
## 定義

- StoreHouseStock_Order：出貨分配操作。
- OrderLine：包含 sku、quantity、warehouseId、noSplit、attributes 等欄位。
- StockItem：倉庫中 SKU 的庫存紀錄（含 total、reserved、locked、batch 等）。
- Reservation：預扣紀錄。
- ShipmentDetail：實際扣減之紀錄。

## 要求與限制

目的與範圍
--------

- 目的：對出貨訂單執行庫存分配與扣減，產生 ShipmentDetail，並保證資料的一致性與可追溯性。
- 範圍：覆蓋分配、預扣、實扣、回滾、事件發佈、日誌與監控需求。

定義
----

- StoreHouseStock_Order：出貨分配操作。
- OrderLine：包含 sku、quantity、warehouseId、noSplit、attributes 等欄位。
- StockItem：倉庫中 SKU 的庫存紀錄（含 total、reserved、locked、batch 等）。
- Reservation：預扣紀錄。
- ShipmentDetail：實際扣減之紀錄。

要求與限制
----------

- **REQ-001**：檢查並確保所有 OrderLine 可用庫存足夠。
- **REQ-002**：扣庫存操作必須在單一資料庫交易中執行；任一失敗應回滾。
- **REQ-003**：支援部分/全數出貨；若 `noSplit=true`，則禁止部分出貨。
- **REQ-004**：建立 ShipmentDetail，記錄來源庫位、批號（如適用）、數量、時間與操作人。
- **REQ-005**：採用鎖定策略避免超賣（悲觀或樂觀鎖）。

輸入 / 輸出 資料契約
------------------

Request (StoreHouseStock_OrderRequest)
-------------------------------------

- `orderId`: string
- `operatorId?`: string
- `reservationOnly?`: boolean
- `lines`: array of
	- `lineId`: string
	- `sku`: string
	- `quantity`: integer
	- `warehouseId?`: string
	- `noSplit?`: boolean
	- `attributes?`: object

Response (StoreHouseStock_OrderResponse)
---------------------------------------

- `success`: boolean
- `orderId`: string
- `results`: array of
	- `lineId`: string
	- `allocated`: integer
	- `allocatedFrom`: array of { warehouseId, locationId?, batchNo?, quantity }
	- `status`: string
	- `reason?`: string
- `errorCode?`: string
- `errorMessage?`: string

流程（高階）
------------

1. 驗證輸入欄位與資料型態。
2. 依倉別與分配策略讀取 candidate StockItem(s)。
3. 計算可用庫存（available = total - reserved - locked）。
4. 在資料庫交易內鎖定並分配：
	 - 若 `reservationOnly`，則增加 `reserved`。
	 - 否則更新 on-hand 與 reserved，並建立 ShipmentDetail。
5. 若所有分配成功則 commit，否則 rollback 並回報錯誤。
6. 發佈事件並寫入操作日誌。

交易與鎖定策略
------------

- 建議在熱點 SKU 使用悲觀鎖（SELECT ... FOR UPDATE），其他情境採樂觀鎖並實作重試機制。
- 鎖定與交易超時應可配置（例如 5 秒）並在超時時回報 TRANSACTION_TIMEOUT。

錯誤代碼（範例）
---------------

- `STOCK_INSUFFICIENT`
- `LOCK_FAILED`
- `VALIDATION_ERROR`
- `TRANSACTION_TIMEOUT`
- `PARTIAL_ALLOCATION_NOT_ALLOWED`

Acceptance Criteria（概要）
-------------------------

- AC-001：正常情況下產生 ShipmentDetail 並回傳 success。
- AC-002：庫存不足時，依 `noSplit` 行為回報 PartialAllocated 或失敗。
- AC-003：任一分配失敗時，整筆交易回滾。
- AC-004：`reservationOnly` 模式僅改變 reserved，不變更 total。

測試建議
--------

- 單元測試：驗證分配邏輯與錯誤處理。
- 整合測試：使用測試資料庫模擬鎖定衝突與重試。
- E2E 測試：模擬高併發情境與補償流程。

範例（JSON）
----------

Request 範例：

```json
{
	"orderId": "ORD-20251113-0001",
	"operatorId": "system",
	"lines": [
		{ "lineId": "L1", "sku": "SKU-AAA", "quantity": 5, "warehouseId": "WH-01" },
		{ "lineId": "L2", "sku": "SKU-BBB", "quantity": 2 }
	]
}
```

Response 範例（成功）：

```json
{
	"success": true,
	"orderId": "ORD-20251113-0001",
	"results": [
		{ "lineId": "L1", "allocated": 5, "allocatedFrom": [{ "warehouseId":"WH-01","quantity":5 }], "status": "Allocated" },
		{ "lineId": "L2", "allocated": 2, "allocatedFrom": [{ "warehouseId":"WH-02","quantity":2 }], "status": "Allocated" }
	]
}
```
version: 1.0
date_created: 2025-11-13
last_updated: 2025-11-13
owner: WebStoreHouse Team
tags:
	- process
	- specification
	- stock
	- order
---

---
title: "StoreHouseStock_Order 出貨明細操作規格 (clean)"
version: 1.0
date_created: 2025-11-13
last_updated: 2025-11-13
owner: WebStoreHouse Team
tags:
	- process
	- specification
	- stock
	- order
---

# StoreHouseStock_Order 操作規格（乾淨版）

本文檔定義 StoreHouseStock_Order 的操作規格，包含資料契約、流程、交易與鎖定策略、錯誤處理、驗收條件與測試建議。

## 目的與範圍

- 目的：對出貨訂單執行庫存分配與扣減，產生 ShipmentDetail，並保證資料的一致性與可追溯性。
- 範圍：覆蓋分配、預扣、實扣、回滾、事件發佈、日誌與監控需求。

## 定義

- StoreHouseStock_Order：出貨分配操作。
- OrderLine：包含 sku、quantity、warehouseId、noSplit、attributes 等欄位。
- StockItem：倉庫中 SKU 的庫存紀錄（含 total、reserved、locked、batch 等）。
- Reservation：預扣紀錄。
- ShipmentDetail：實際扣減之紀錄。

## 要求與限制

- **REQ-001**：檢查並確保所有 OrderLine 可用庫存足夠。
- **REQ-002**：扣庫存操作必須在單一資料庫交易中執行；任一失敗應回滾。
- **REQ-003**：支援部分/全數出貨；若 `noSplit=true`，則禁止部分出貨。
- **REQ-004**：建立 ShipmentDetail，記錄來源庫位、批號（如適用）、數量、時間與操作人。
- **REQ-005**：採用鎖定策略避免超賣（悲觀或樂觀鎖）。

## 輸入 / 輸出 資料契約

### Request (StoreHouseStock_OrderRequest)


- `orderId`: string
- `operatorId?`: string
- `reservationOnly?`: boolean
- `lines`: array of
  - `lineId`: string
  - `sku`: string
  - `quantity`: integer
  - `warehouseId?`: string
  - `noSplit?`: boolean
  - `attributes?`: object

### Response (StoreHouseStock_OrderResponse)


- `success`: boolean
- `orderId`: string
- `results`: array of
  - `lineId`: string
  - `allocated`: integer
  - `allocatedFrom`: array of { warehouseId, locationId?, batchNo?, quantity }
  - `status`: string
  - `reason?`: string
- `errorCode?`: string
- `errorMessage?`: string

## 流程（高階）

1. 驗證輸入欄位與資料型態。
2. 依倉別與分配策略讀取 candidate StockItem(s)。
3. 計算可用庫存（available = total - reserved - locked）。
4. 在資料庫交易內鎖定並分配：
	 - 若 `reservationOnly`，則增加 `reserved`。
	 - 否則更新 on-hand 與 reserved，並建立 ShipmentDetail。
5. 若所有分配成功則 commit，否則 rollback 並回報錯誤。
6. 發佈事件並寫入操作日誌。

## 交易與鎖定策略

- 建議在熱點 SKU 使用悲觀鎖（SELECT ... FOR UPDATE），其他情境採樂觀鎖並實作重試機制。
- 鎖定與交易超時應可配置（例如 5 秒）並在超時時回報 TRANSACTION_TIMEOUT。

## 錯誤代碼（範例）

- `STOCK_INSUFFICIENT`
- `LOCK_FAILED`
- `VALIDATION_ERROR`
- `TRANSACTION_TIMEOUT`
- `PARTIAL_ALLOCATION_NOT_ALLOWED`

## Acceptance Criteria（概要）

- AC-001：正常情況下產生 ShipmentDetail 並回傳 success。
- AC-002：庫存不足時，依 `noSplit` 行為回報 PartialAllocated 或失敗。
- AC-003：任一分配失敗時，整筆交易回滾。
- AC-004：`reservationOnly` 模式僅改變 reserved，不變更 total。

## 測試建議

- 單元測試：驗證分配邏輯與錯誤處理。
- 整合測試：使用測試資料庫模擬鎖定衝突與重試。
- E2E 測試：模擬高併發情境與補償流程。

## 範例（JSON）

Request 範例：

```json
{
	"orderId": "ORD-20251113-0001",
	"operatorId": "system",
	"lines": [
		{ "lineId": "L1", "sku": "SKU-AAA", "quantity": 5, "warehouseId": "WH-01" },
		{ "lineId": "L2", "sku": "SKU-BBB", "quantity": 2 }
	]
}
```

Response 範例（成功）：

```json
{
	"success": true,
	"orderId": "ORD-20251113-0001",
	"results": [
		{ "lineId": "L1", "allocated": 5, "allocatedFrom": [{ "warehouseId":"WH-01","quantity":5 }], "status": "Allocated" },
		{ "lineId": "L2", "allocated": 2, "allocatedFrom": [{ "warehouseId":"WH-02","quantity":2 }], "status": "Allocated" }
	]
}
```

---

注意：我已在相同目錄下建立乾淨版本 `出貨明細.clean.md`，因為原始 `出貨明細.md` 在多次自動編輯中出現重複與格式錯誤。若您要我把乾淨版本覆蓋原檔，我可以在得到您確認後執行單一原子覆寫，並在覆寫後重新執行 linter 檢查。
  - specification
  - stock
  - order

StoreHouseStock_Order 操作邏輯
===============================

本文件詳細定義 `StoreHouseStock_Order` 的操作流程、資料契約、交易與鎖定行為、驗證規則、錯誤處理、以及驗收條件。目標是讓開發、測試與運維人員能夠按照此規格實作或驗證功能。

目的與範圍
-----------

- 目的：在倉儲系統中，針對出貨需求（Order）執行庫存撥出/扣減的原子化操作，並產生出貨明細（shipment details）。
- 範圍：此規格涵蓋單筆出貨（單一訂單或訂單明細）至多筆庫存貨項的分配、預扣、實扣、回滾、事件發佈與日誌。假設以關聯式資料庫為主儲存，並支援交易（Transaction）與悲觀或樂觀鎖定策略。

定義
----

- StoreHouseStock_Order：一組針對倉庫庫存執行的出貨操作邏輯（方法/流程）。
- Order：客戶的出貨訂單，含一或多筆 OrderLine（訂單明細）。
- OrderLine：訂單明細，包含 SKU、數量、要求出貨倉別、批號或序號條件（若適用）。
- StockItem：倉庫中某 SKU 的庫存紀錄（包含可用數量、預扣數量、鎖定數量、批號資訊）。
- ShipmentDetail（出貨明細）：實際從庫存扣減並將要出貨的紀錄。
- Reservation（預扣/預留）：當訂單被接受但尚未完成出貨時，保留庫存以避免被其他出貨佔用。

需求、限制與指引
-----------------

- REQ-001: 當執行 StoreHouseStock_Order 時，系統須確認所有 OrderLine 的可用庫存是否足夠。
- REQ-002: 扣庫存必須在資料庫交易範圍內執行；若任一項失敗，整個出貨操作須回滾。
- REQ-003: 支援部分出貨與全數出貨兩種情境；對於要求「不可部分出貨」(no-split) 的訂單，若任一 OrderLine 數量不足，應拒絕整筆操作並回報不足資訊。
- REQ-004: 執行時須產生 ShipmentDetail 記錄，記錄來源庫位、批號（如有）、扣減數量、時間與操作人（或系統）。
- REQ-005: 在高併發環境下，必須採取鎖定策略避免競爭導致超賣（oversell）。建議優先使用悲觀鎖定於熱點庫存紀錄；若使用樂觀鎖定，必須在衝突時重試與明確回滾。
- REQ-006: 對外介面須回傳清楚之錯誤代碼與說明，包含：庫存不足、鎖定失敗、資料驗證錯誤、交易逾時等。
- REQ-007: 所有變更須寫入操作日誌（audit log），包含回滾原因。

輸入 / 輸出 資料契約
-------------------

Request: StoreHouseStock_OrderRequest

- orderId: string  // 訂單編號
- lines: Array of {
	- lineId: string
	- sku: string
	- quantity: integer
	- warehouseId?: string  // 要求倉別（可選）
	- noSplit?: boolean     // 不允許部分出貨
	- attributes?: object   // 如批號、序號偏好
}
- operatorId?: string  // 操作人或系統識別
- reservationOnly?: boolean // 是否僅預扣（true = 只預留不實扣）

Response: StoreHouseStock_OrderResponse

- success: boolean
- orderId: string
- results: Array of {
	- lineId: string
	- allocated: integer   // 已分配數量
	- allocatedFrom: Array of { warehouseId, locationId?, batchNo?, quantity }
	- status: string // e.g., "Allocated", "PartialAllocated", "Rejected"
	- reason?: string
}
- errorCode?: string
- errorMessage?: string

介面與流程步驟（高階）
-------------------

1. 驗證輸入資料（格式、必填欄位、數量正整數）。
2. 對每一筆 OrderLine，讀取 candidate StockItem(s)：遵循倉別優先、先進先出（FIFO）或其他批號策略。
3. 檢查可用庫存（available = total - reserved - locked）是否能滿足需求。
4. 於交易內進行鎖定/預扣：
	 - 若 reservationOnly = true：更新 reserved 數量但不減 total。產生 Reservation 記錄。
	 - 否則：更新 total/available（依實作可能更新 on-hand 與 reserved 欄位），並建立 ShipmentDetail。
5. 若所有 OrderLine 成功分配，提交交易並回傳 success；否則回滾並回傳失敗原因。
6. 發佈事件（Event）如 StockAllocated、StockReservationFailed，供後續系統（例如倉儲 WMS、發票系統）處理。

交易與鎖定策略
----------------

- 交易範圍：整個 StoreHouseStock_Order 操作應包在單一資料庫交易（DB Transaction）中，以確保原子性。
- 鎖定策略選項：
	- 悲觀鎖（Pessimistic Locking）：在讀取 StockItem 時用 SELECT ... FOR UPDATE（或等價）鎖住庫存列，適用於高併發、熱點 SKU。若無法取得鎖，回報鎖定失敗或重試。
	- 樂觀鎖（Optimistic Locking）：使用版本號 (rowversion/timestamp) 或版次欄位，於更新時檢查版本一致性；若衝突則重試 N 次（例如 3 次）後失敗。
- 建議：對於 hot SKU 使用悲觀鎖；對於一般情況可採樂觀鎖並在業務層重試。
- 超時與重試：鎖定或交易若超時（例如 5s）應中止並回報交易逾時；重試次數與回退策略應可配置。

資料一致性與補償流程
-------------------

- 一致性：最終一致性允許在非同步子系統間，但庫存扣減本身必須立即在 DB 中反映（強一致性）。
- 補償：若後續流程（例如運輸安排）失敗並需回復庫存，應提供可呼叫的 compensating API（例如 StoreHouseStock_ReleaseReservation 或 StoreHouseStock_RollbackShipment）來還原 reservation 或補回庫存，並記錄原因。

驗證與錯誤處理
----------------

- 驗證規則：
	- quantity 必須為正整數。
	- sku 必須存在於商品資料表。
	- 若 warehouseId 提供，該倉別必須允許該 SKU 出貨。
- 常見錯誤代碼（範例）：
	- STOCK_INSUFFICIENT: 庫存不足
	- LOCK_FAILED: 鎖定庫存失敗
	- VALIDATION_ERROR: 輸入驗證失敗
	- TRANSACTION_TIMEOUT: 交易逾時
	- PARTIAL_ALLOCATION_NOT_ALLOWED: 不允許部分出貨

Acceptance Criteria（驗收條件，使用 Given-When-Then）
-----------------------------------------------

- AC-001 (正常分配): Given 一筆 OrderLine，其 candidate 庫存充足、When 呼叫 StoreHouseStock_Order，Then 回傳 success=true 並在 ShipmentDetail 產生相對應扣減紀錄。

- AC-002 (庫存不足): Given 一筆 OrderLine，其可用庫存不足、When 呼叫且 noSplit=false，Then 回傳 success=true 並標示該 line 為 PartialAllocated（若系統允許部分出貨）；若 noSplit=true，Then 回傳 success=false 與 errorCode=STOCK_INSUFFICIENT。

- AC-003 (交易原子性): Given 多筆 OrderLine，其中一筆在分配時發生錯誤（例如 LOCK_FAILED），When 呼叫 StoreHouseStock_Order，Then 所有已執行的分配都應回滾，資料庫中不應有任何變更。

- AC-004 (預扣模式): Given reservationOnly=true，When 呼叫，Then reserved 欄位增加、total 不變，並產生 Reservation 記錄；此操作可被後續的實扣 API consume。

測試自動化策略
----------------

- Test Levels: Unit、Integration、End-to-End
- Frameworks: 建議使用現有專案的測試框架（例如 NUnit / MSTest / xUnit）與測試用 DB（或使用 In-Memory + 模擬悲觀鎖情境）。
- 必要測試案例：
	- 單一行正常分配
	- 多行同時分配（含不同倉別）
	- 部分分配與 noSplit=true 拒絕
	- 鎖定衝突模擬（測試重試與回滾）
	- reservationOnly 模式
	- 補償 API 還原情境

範例（JSON 請求 / 回應）
---------------------

Request 範例:

```json
{
	"orderId": "ORD-20251113-0001",
	"operatorId": "system",
	"lines": [
		{ "lineId": "L1", "sku": "SKU-AAA", "quantity": 5, "warehouseId": "WH-01" },
		{ "lineId": "L2", "sku": "SKU-BBB", "quantity": 2 }
	]
}
```

Response 範例（成功）:

```json
{
	"success": true,
	"orderId": "ORD-20251113-0001",
	"results": [
		{ "lineId": "L1", "allocated": 5, "allocatedFrom": [{ "warehouseId":"WH-01","quantity":5 }], "status": "Allocated" },
		{ "lineId": "L2", "allocated": 2, "allocatedFrom": [{ "warehouseId":"WH-02","quantity":2 }], "status": "Allocated" }
	]
}
```

邊界條件與例外情境
-----------------

- 大量並發 (thundering herd)：系統應採用排隊或限流（rate limit）機制，避免短時間大量併發導致鎖等待或死鎖。
- 批號/序號管理：若 SKU 需要按批號或序號發貨，分配時需考慮有效期、保質期限與先到先出策略。
- 庫存異常負數：系統禁止產生負庫存；若發生需人工介入並觸發警報。

驗證標準（Validation Criteria）
----------------------------

- 所有 Acceptance Criteria 測試皆綠燈（unit + integration + e2e）。
- 在模擬高併發情境下，系統不得產生超賣（oversell）情況。
- 所有錯誤情境必須產生可追溯的日誌與錯誤代碼。

相關規格與進一步閱讀
---------------------

- 相關 API: StoreHouseStock_ReleaseReservation、StoreHouseStock_RollbackShipment、ShipmentService_Create
- 參考: 公司庫存管理流程文件、WMS 介面規格

備註與後續建議
-----------------

- 建議在實作前決定鎖定策略（悲觀或樂觀）及重試參數，並將此設定化（configurable）。
- 建議實作詳細監控（metrics）與警報：分配成功率、鎖定失敗率、交易逾時率。

title: StoreHouseStock_Order 出貨明細操作規格
version: 1.0
date_created: 2025-11-13
last_updated: 2025-11-13
owner: WebStoreHouse Team
tags:
  - process
  - specification
  - stock
  - order

StoreHouseStock_Order 操作邏輯
================================

本文件詳細定義 `StoreHouseStock_Order` 的操作流程、資料契約、交易與鎖定行為、驗證規則、錯誤處理、以及驗收條件。目標是讓開發、測試與運維人員能夠按照此規格實作或驗證功能。

目的與範圍
---------------

- 目的：在倉儲系統中，針對出貨需求（Order）執行庫存撥出/扣減的原子化操作，並產生出貨明細（shipment details）。
- 範圍：此規格涵蓋單筆出貨（單一訂單或訂單明細）至多筆庫存貨項的分配、預扣、實扣、回滾、事件發佈與日志。假設以關聯式資料庫為主儲存，並支援交易（Transaction）與悲觀或樂觀鎖定策略。

定義
-----

- StoreHouseStock_Order：一組針對倉庫庫存執行的出貨操作邏輯（方法/流程）。
- Order：客戶的出貨訂單，含一或多筆 OrderLine（訂單明細）。
- OrderLine：訂單明細，包含 SKU、數量、要求出貨倉別、批號或序號條件（若適用）。
- StockItem：倉庫中某 SKU 的庫存紀錄（包含可用數量、預扣數量、鎖定數量、批號資訊）。
- ShipmentDetail（出貨明細）：實際從庫存扣減並將要出貨的紀錄。
- Reservation（預扣/預留）：當訂單被接受但尚未完成出貨時，保留庫存以避免被其他出貨佔用。

需求、限制與指引
------------------

- REQ-001: 當執行 StoreHouseStock_Order 時，系統須確認所有 OrderLine 的可用庫存是否足夠。
- REQ-002: 扣庫存必須在資料庫交易範圍內執行；若任一項失敗，整個出貨操作須回滾。
- REQ-003: 支援部分出貨與全數出貨兩種情境；對於要求「不可部分出貨」(no-split) 的訂單，若任一 OrderLine 數量不足，應拒絕整筆操作並回報不足資訊。
- REQ-004: 執行時須產生 ShipmentDetail 記錄，記錄來源庫位、批號（如有）、扣減數量、時間與操作人（或系統）。
- REQ-005: 在高併發環境下，必須採取鎖定策略避免競爭導致超賣（oversell）。建議優先使用悲觀鎖定於熱點庫存紀錄；若使用樂觀鎖定，必須在衝突時重試與明確回滾。
- REQ-006: 對外介面須回傳清楚之錯誤代碼與說明，包含：庫存不足、鎖定失敗、資料驗證錯誤、交易逾時等。
- REQ-007: 所有變更須寫入操作日誌（audit log），包含回滾原因。

輸入 / 輸出 資料契約
---------------------

Request: StoreHouseStock_OrderRequest

- orderId: string  // 訂單編號
- lines: Array of {
	- lineId: string
	- sku: string
	- quantity: integer
	- warehouseId?: string  // 要求倉別（可選）
	- noSplit?: boolean     // 不允許部分出貨
	- attributes?: object   // 如批號、序號偏好
}
- operatorId?: string  // 操作人或系統識別
- reservationOnly?: boolean // 是否僅預扣（true = 只預留不實扣）

Response: StoreHouseStock_OrderResponse

- success: boolean
- orderId: string
- results: Array of {
	- lineId: string
	- allocated: integer   // 已分配數量
	- allocatedFrom: Array of { warehouseId, locationId?, batchNo?, quantity }
	- status: string // e.g., "Allocated", "PartialAllocated", "Rejected"
	- reason?: string
}
- errorCode?: string
- errorMessage?: string

介面與流程步驟（高階）
--------------------

1. 驗證輸入資料（格式、必填欄位、數量正整數）。
2. 對每一筆 OrderLine，讀取 candidate StockItem(s)：遵循倉別優先、先進先出（FIFO）或其他批號策略。
3. 檢查可用庫存（available = total - reserved - locked）是否能滿足需求。
4. 於交易內進行鎖定/預扣：
	 - 若 reservationOnly = true：更新 reserved 數量但不減 total。產生 Reservation 記錄。
	 - 否則：更新 total/available（依實作可能更新 on-hand 與 reserved 欄位），並建立 ShipmentDetail。
5. 若所有 OrderLine 成功分配，提交交易並回傳 success；否則回滾並回傳失敗原因。
6. 發佈事件（Event）如 StockAllocated、StockReservationFailed，供後續系統（例如倉儲 WMS、發票系統）處理。

交易與鎖定策略
----------------

- 交易範圍：整個 StoreHouseStock_Order 操作應包在單一資料庫交易（DB Transaction）中，以確保原子性。
- 鎖定策略選項：
	- 悲觀鎖（Pessimistic Locking）：在讀取 StockItem 時用 SELECT ... FOR UPDATE（或等價）鎖住庫存列，適用於高併發、熱點 SKU。若無法取得鎖，回報鎖定失敗或重試。
	- 樂觀鎖（Optimistic Locking）：使用版本號 (rowversion/timestamp) 或版次欄位，於更新時檢查版本一致性；若衝突則重試 N 次（例如 3 次）後失敗。
- 建議：對於 hot SKU 使用悲觀鎖；對於一般情況可採樂觀鎖並在業務層重試。
- 超時與重試：鎖定或交易若超時（例如 5s）應中止並回報交易逾時；重試次數與回退策略應可配置。

資料一致性與補償流程
--------------------

- 一致性：最終一致性允許在非同步子系統間，但庫存扣減本身必須立即在 DB 中反映（強一致性）。
- 補償：若後續流程（例如運輸安排）失敗並需回復庫存，應提供可呼叫的 compensating API（例如 StoreHouseStock_ReleaseReservation 或 StoreHouseStock_RollbackShipment）來還原 reservation 或補回庫存，並記錄原因。

驗證與錯誤處理
----------------

- 驗證規則：
	- quantity 必須為正整數。
	- sku 必須存在於商品資料表。
	- 若 warehouseId 提供，該倉別必須允許該 SKU 出貨。
- 常見錯誤代碼（範例）：
	- STOCK_INSUFFICIENT: 庫存不足
	- LOCK_FAILED: 鎖定庫存失敗
	- VALIDATION_ERROR: 輸入驗證失敗
	- TRANSACTION_TIMEOUT: 交易逾時
	- PARTIAL_ALLOCATION_NOT_ALLOWED: 不允許部分出貨

Acceptance Criteria（驗收條件，使用 Given-When-Then）
------------------------------------------------

- AC-001 (正常分配): Given 一筆 OrderLine，其 candidate 庫存充足、When 呼叫 StoreHouseStock_Order，Then 回傳 success=true 並在 ShipmentDetail 產生相對應扣減紀錄。

- AC-002 (庫存不足): Given 一筆 OrderLine，其可用庫存不足、When 呼叫且 noSplit=false，Then 回傳 success=true 並標示該 line 為 PartialAllocated（若系統允許部分出貨）；若 noSplit=true，Then 回傳 success=false 與 errorCode=STOCK_INSUFFICIENT。

- AC-003 (交易原子性): Given 多筆 OrderLine，其中一筆在分配時發生錯誤（例如 LOCK_FAILED），When 呼叫 StoreHouseStock_Order，Then 所有已執行的分配都應回滾，資料庫中不應有任何變更。

- AC-004 (預扣模式): Given reservationOnly=true，When 呼叫，Then reserved 欄位增加、total 不變，並產生 Reservation 記錄；此操作可被後續的實扣 API consume。

測試自動化策略
----------------

- Test Levels: Unit、Integration、End-to-End
- Frameworks: 建議使用現有專案的測試框架（例如 NUnit / MSTest / xUnit）與測試用 DB（或使用 In-Memory + 模擬悲觀鎖情境）。
- 必要測試案例：
	- 單一行正常分配
	- 多行同時分配（含不同倉別）
	- 部分分配與 noSplit=true 拒絕
	- 鎖定衝突模擬（測試重試與回滾）
	- reservationOnly 模式
	- 補償 API 還原情境

範例（JSON 請求 / 回應）
---------------------

Request 範例:

```json
{
	"orderId": "ORD-20251113-0001",
	"operatorId": "system",
	"lines": [
		{ "lineId": "L1", "sku": "SKU-AAA", "quantity": 5, "warehouseId": "WH-01" },
		{ "lineId": "L2", "sku": "SKU-BBB", "quantity": 2 }
	]
}
```

Response 範例（成功）:

```json
{
	"success": true,
	"orderId": "ORD-20251113-0001",
	"results": [
		{ "lineId": "L1", "allocated": 5, "allocatedFrom": [{ "warehouseId":"WH-01","quantity":5 }], "status": "Allocated" },
		{ "lineId": "L2", "allocated": 2, "allocatedFrom": [{ "warehouseId":"WH-02","quantity":2 }], "status": "Allocated" }
	]
}
```

邊界條件與例外情境
-----------------

- 大量並發 (thundering herd)：系統應採用排隊或限流（rate limit）機制，避免短時間大量併發導致鎖等待或死鎖。
- 批號/序號管理：若 SKU 需要按批號或序號發貨，分配時需考慮有效期、保質期限與先到先出策略。
- 庫存異常負數：系統禁止產生負庫存；若發生需人工介入並觸發警報。

驗證標準（Validation Criteria）
----------------------------

- 所有 Acceptance Criteria 測試皆綠燈（unit + integration + e2e）。
- 在模擬高併發情境下，系統不得產生超賣（oversell）情況。
- 所有錯誤情境必須產生可追溯的日誌與錯誤代碼。

相關規格與進一步閱讀
---------------------

- 相關 API: StoreHouseStock_ReleaseReservation、StoreHouseStock_RollbackShipment、ShipmentService_Create
- 參考: 公司庫存管理流程文件、WMS 介面規格

備註與後續建議
-----------------

- 建議在實作前決定鎖定策略（悲觀或樂觀）及重試參數，並將此設定化（configurable）。
- 建議實作詳細監控（metrics）與警報：分配成功率、鎖定失敗率、交易逾時率。


---
title: StoreHouseStock_Order 出貨明細操作規格
version: 1.0
date_created: 2025-11-13
last_updated: 2025-11-13
owner: WebStoreHouse Team
tags: [process, specification, stock, order]
---

# StoreHouseStock_Order 操作邏輯

本文件詳細定義 `StoreHouseStock_Order` 的操作流程、資料契約、交易與鎖定行為、驗證規則、錯誤處理、以及驗收條件。目標是讓開發、測試與運維人員能夠按照此規格實作或驗證功能。

## 1. 目的與範圍

---
title: StoreHouseStock_Order 出貨明細操作規格
version: 1.0
date_created: 2025-11-13
last_updated: 2025-11-13
owner: WebStoreHouse Team
tags:
	- process
	- specification
	- stock
	- order
---

# StoreHouseStock_Order 操作邏輯

本文件詳細定義 `StoreHouseStock_Order` 的操作流程、資料契約、交易與鎖定行為、驗證規則、錯誤處理、以及驗收條件。目標是讓開發、測試與運維人員能夠按照此規格實作或驗證功能。

## 1. 目的與範圍

- 目的：在倉儲系統中，針對出貨需求（Order）執行庫存撥出/扣減的原子化操作，並產生出貨明細（shipment details）。
- 範圍：此規格涵蓋單筆出貨（單一訂單或訂單明細）至多筆庫存貨項的分配、預扣、實扣、回滾、事件發佈與日志。假設以關聯式資料庫為主儲存，並支援交易（Transaction）與悲觀或樂觀鎖定策略。

## 2. 定義

- StoreHouseStock_Order：一組針對倉庫庫存執行的出貨操作邏輯（方法/流程）。
- Order：客戶的出貨訂單，含一或多筆 OrderLine（訂單明細）。
- OrderLine：訂單明細，包含 SKU、數量、要求出貨倉別、批號或序號條件（若適用）。
- StockItem：倉庫中某 SKU 的庫存紀錄（包含可用數量、預扣數量、鎖定數量、批號資訊）。
- ShipmentDetail（出貨明細）：實際從庫存扣減並將要出貨的紀錄。
- Reservation（預扣/預留）：當訂單被接受但尚未完成出貨時，保留庫存以避免被其他出貨佔用。

## 3. 需求、限制與指引

- REQ-001: 當執行 StoreHouseStock_Order 時，系統須確認所有 OrderLine 的可用庫存是否足夠。
- REQ-002: 扣庫存必須在資料庫交易範圍內執行；若任一項失敗，整個出貨操作須回滾。
- REQ-003: 支援部分出貨與全數出貨兩種情境；對於要求「不可部分出貨」(no-split) 的訂單，若任一 OrderLine 數量不足，應拒絕整筆操作並回報不足資訊。
- REQ-004: 執行時須產生 ShipmentDetail 記錄，記錄來源庫位、批號（如有）、扣減數量、時間與操作人（或系統）。
- REQ-005: 在高併發環境下，必須採取鎖定策略避免競爭導致超賣（oversell）。建議優先使用悲觀鎖定於熱點庫存紀錄；若使用樂觀鎖定，必須在衝突時重試與明確回滾。
- REQ-006: 對外介面須回傳清楚之錯誤代碼與說明，包含：庫存不足、鎖定失敗、資料驗證錯誤、交易逾時等。
- REQ-007: 所有變更須寫入操作日誌（audit log），包含回滾原因。

## 4. 輸入 / 輸出 資料契約

Request: StoreHouseStock_OrderRequest

- orderId: string  // 訂單編號
- lines: Array of {
	- lineId: string
	- sku: string
	- quantity: integer
	- warehouseId?: string  // 要求倉別（可選）
	- noSplit?: boolean     // 不允許部分出貨
	- attributes?: object   // 如批號、序號偏好
}
- operatorId?: string  // 操作人或系統識別
- reservationOnly?: boolean // 是否僅預扣（true = 只預留不實扣）

Response: StoreHouseStock_OrderResponse

- success: boolean
- orderId: string
- results: Array of {
	- lineId: string
	- allocated: integer   // 已分配數量
	- allocatedFrom: Array of { warehouseId, locationId?, batchNo?, quantity }
	- status: string // e.g., "Allocated", "PartialAllocated", "Rejected"
	- reason?: string
}
- errorCode?: string
- errorMessage?: string


## 5. 介面與流程步驟（高階）

1. 驗證輸入資料（格式、必填欄位、數量正整數）。
2. 對每一筆 OrderLine，讀取 candidate StockItem(s)：遵循倉別優先、先進先出（FIFO）或其他批號策略。
3. 檢查可用庫存（available = total - reserved - locked）是否能滿足需求。
4. 於交易內進行鎖定/預扣：
	 - 若 reservationOnly = true：更新 reserved 數量但不減 total。產生 Reservation 記錄。
	 - 否則：更新 total/available（依實作可能更新 on-hand 與 reserved 欄位），並建立 ShipmentDetail。
5. 若所有 OrderLine 成功分配，提交交易並回傳 success；否則回滾並回傳失敗原因。
6. 發佈事件（Event）如 StockAllocated、StockReservationFailed，供後續系統（例如倉儲 WMS、發票系統）處理。


## 6. 交易與鎖定策略

- 交易範圍：整個 StoreHouseStock_Order 操作應包在單一資料庫交易（DB Transaction）中，以確保原子性。
- 鎖定策略選項：
	- 悲觀鎖（Pessimistic Locking）：在讀取 StockItem 時用 SELECT ... FOR UPDATE（或等價）鎖住庫存列，適用於高併發、熱點 SKU。若無法取得鎖，回報鎖定失敗或重試。
	- 樂觀鎖（Optimistic Locking）：使用版本號 (rowversion/timestamp) 或版次欄位，於更新時檢查版本一致性；若衝突則重試 N 次（例如 3 次）後失敗。
- 建議：對於 hot SKU 使用悲觀鎖；對於一般情況可採樂觀鎖並在業務層重試。
- 超時與重試：鎖定或交易若超時（例如 5s）應中止並回報交易逾時；重試次數與回退策略應可配置。


## 7. 資料一致性與補償流程

- 一致性：最終一致性允許在非同步子系統間，但庫存扣減本身必須立即在 DB 中反映（強一致性）。
- 補償：若後續流程（例如運輸安排）失敗並需回復庫存，應提供可呼叫的 compensating API（例如 StoreHouseStock_ReleaseReservation 或 StoreHouseStock_RollbackShipment）來還原 reservation 或補回庫存，並記錄原因。


## 8. 驗證與錯誤處理

- 驗證規則：
	- quantity 必須為正整數。
	- sku 必須存在於商品資料表。
	- 若 warehouseId 提供，該倉別必須允許該 SKU 出貨。
- 常見錯誤代碼（範例）：
	- STOCK_INSUFFICIENT: 庫存不足
	- LOCK_FAILED: 鎖定庫存失敗
	- VALIDATION_ERROR: 輸入驗證失敗
	- TRANSACTION_TIMEOUT: 交易逾時
	- PARTIAL_ALLOCATION_NOT_ALLOWED: 不允許部分出貨


## 9. Acceptance Criteria（驗收條件，使用 Given-When-Then）

- AC-001 (正常分配): Given 一筆 OrderLine，其 candidate 庫存充足、When 呼叫 StoreHouseStock_Order，Then 回傳 success=true 並在 ShipmentDetail 產生相對應扣減紀錄。

- AC-002 (庫存不足): Given 一筆 OrderLine，其可用庫存不足、When 呼叫且 noSplit=false，Then 回傳 success=true 並標示該 line 為 PartialAllocated（若系統允許部分出貨）；若 noSplit=true，Then 回傳 success=false 與 errorCode=STOCK_INSUFFICIENT。

- AC-003 (交易原子性): Given 多筆 OrderLine，其中一筆在分配時發生錯誤（例如 LOCK_FAILED），When 呼叫 StoreHouseStock_Order，Then 所有已執行的分配都應回滾，資料庫中不應有任何變更。

- AC-004 (預扣模式): Given reservationOnly=true，When 呼叫，Then reserved 欄位增加、total 不變，並產生 Reservation 記錄；此操作可被後續的實扣 API consume。


## 10. 測試自動化策略

- Test Levels: Unit、Integration、End-to-End
- Frameworks: 建議使用現有專案的測試框架（例如 NUnit / MSTest / xUnit）與測試用 DB（或使用 In-Memory + 模擬悲觀鎖情境）。
- 必要測試案例：
	- 單一行正常分配
	- 多行同時分配（含不同倉別）
	- 部分分配與 noSplit=true 拒絕
	- 鎖定衝突模擬（測試重試與回滾）
	- reservationOnly 模式
	- 補償 API 還原情境


## 11. 範例（JSON 請求 / 回應）

Request 範例:

```json
{
	"orderId": "ORD-20251113-0001",
	"operatorId": "system",
	"lines": [
		{ "lineId": "L1", "sku": "SKU-AAA", "quantity": 5, "warehouseId": "WH-01" },
		{ "lineId": "L2", "sku": "SKU-BBB", "quantity": 2 }
	]
}
```

Response 範例（成功）:

```json
{
	"success": true,
	"orderId": "ORD-20251113-0001",
	"results": [
		{ "lineId": "L1", "allocated": 5, "allocatedFrom": [{ "warehouseId":"WH-01","quantity":5 }], "status": "Allocated" },
		{ "lineId": "L2", "allocated": 2, "allocatedFrom": [{ "warehouseId":"WH-02","quantity":2 }], "status": "Allocated" }
	]
}
```


## 12. 邊界條件與例外情境

- 大量並發 (thundering herd)：系統應採用排隊或限流（rate limit）機制，避免短時間大量併發導致鎖等待或死鎖。
- 批號/序號管理：若 SKU 需要按批號或序號發貨，分配時需考慮有效期、保質期限與先到先出策略。
- 庫存異常負數：系統禁止產生負庫存；若發生需人工介入並觸發警報。


## 13. 驗證標準（Validation Criteria）

- 所有 Acceptance Criteria 測試皆綠燈（unit + integration + e2e）。
- 在模擬高併發情境下，系統不得產生超賣（oversell）情況。
- 所有錯誤情境必須產生可追溯的日誌與錯誤代碼。


## 14. 相關規格與進一步閱讀

- 相關 API: StoreHouseStock_ReleaseReservation、StoreHouseStock_RollbackShipment、ShipmentService_Create
- 參考: 公司庫存管理流程文件、WMS 介面規格


## 15. 備註與後續建議

- 建議在實作前決定鎖定策略（悲觀或樂觀）及重試參數，並將此設定化（configurable）。
- 建議實作詳細監控（metrics）與警報：分配成功率、鎖定失敗率、交易逾時率。

---

