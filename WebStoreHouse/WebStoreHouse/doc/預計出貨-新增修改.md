---
title: 預計出貨（E_StoreHouseStock_SC）- 新增/修改 規格
version: 1.0
date_created: 2025-11-13
last_updated: 2025-11-13
owner: Warehouse Team
tags: [process, data, spec]
---

# Introduction

本規格描述與「預計出貨」資料表 `E_StoreHouseStock_SC`（資料表名：`StoreHouseStock_SC`）相關的新增、修改、刪除行為與介面，目標是定義系統中哪些功能會寫入此資料表、寫入的欄位與條件、交易/例外處理要求，以及可被自動化測試驗收的準則。

## 1. Purpose & Scope

- 目的：明確列出系統中會對 `E_StoreHouseStock_SC` 做新增/修改/刪除（CRUD 寫入）之功能點與約束，並提供可自動驗證的接受準則。
- 範圍：本文件僅描述與 `E_StoreHouseStock_SC` 直接互動的 API/Controller 行為與資料契約；不包含資料庫內部實作細節（如索引、觸發器）或其他無直接寫入該表的輔助表。
- 讀者：後端工程師、測試工程師、系統整合工程師。

## 2. Definitions

- E_StoreHouseStock_SC: Entity Framework 實體，對應資料表 `StoreHouseStock_SC`（預計出貨明細）。
- IsApproved: 單筆是否被確認為正式出貨（'N' = 購物車/草稿, 'Y' = 已確認及公司名稱不為空）。
- OrderGuid: 訂單識別碼，將多筆 SC 明細關聯為同一出貨訂單。

## 3. Requirements, Constraints & Guidelines

- **REQ-001**: 新增記錄時，系統必須設定 `IsApproved` 為適當值（新增於出貨轉換流程時為 `N`，確認/下單流程會改為 `Y`）。
- **REQ-002**: 當由已銷單庫存寫入 SC（BOS_toShip），新增的 SC 欄位至少包含 `exp_shipdate`, `eng_sr`, `exp_shipquantity`, `stock_quantity`, `position`, `transportation`, `IsApproved`, `sales_order`, `cust_wono`, `wono`。
- **REQ-003**: 當建立訂單（或確認出貨）時，系統需將購物車狀態（IsApproved='N'）之 SC 逐筆更新為 `IsApproved = 'Y'` 並寫入相同的 `OrderGuid`。
- **REQ-004**: 刪除 SC 時應先檢查該筆是否存在；若為 null，不應拋出未處理例外，而需返回友善錯誤或無操作。
- **CON-001**: 重要寫入流程（例如 BOS_toShip 與 OrderConfirm）應使用資料庫交易（transaction）。若交易失敗，應回滾並保留錯誤訊息供排查。
- **GUD-001**: 所有更新或刪除操作應先做 Null 檢查，並在必要時記錄變更者（UserId）與時間（若表格無欄位，可考慮擴充或在 Audit Log 記錄）。

## 4. Interfaces & Data Contracts

以下為常見操作對 `E_StoreHouseStock_SC` 的欄位需求與範例：

- 新增（BOS_toShip） -> AddRange(tos)
	- 必要欄位：
		- `exp_shipdate` (string, yyyy-MM-dd)
		- `eng_sr` (string)
		- `exp_shipquantity` (int)
		- `stock_quantity` (int)  // 寫入時通常為庫存原始數量 + 出貨數量
		- `position` (string)
		- `transportation` (string)
		- `IsApproved` (string) 預設 "N"
		- `sales_order` (string) 可為 "N/A" 或業務單號
		- `cust_wono` (string)
		- `wono` (string) e.g. "無工單出貨"

- 修改（Edit_SC / Edit_SCbos） -> Find(ssno) / Where(...) => 修改欄位後 SaveChanges()
	- 可能變更欄位：`company_name`, `address`, `company_code`, `exp_shipquantity`, `sap_mark`, `sap_in`, `position`, `transportation`, `stock_quantity`, `box_quantity`, `inputdate`。

- 刪除（Delete_SC / DeleteCar） -> Remove(entity) + SaveChanges()
	- 刪除前應確認 entity 不為 null。

## 5. Acceptance Criteria

- **AC-001**: Given 已銷單庫存有資料，When 呼叫 `BOS_toShip` 並提交有效 `eng_sr`、`ship_quantity`、`position`，Then 應：
	- 扣減 `E_StoreHouseStock_BOS.quantity`，設定 `ship_quantity` 與 `ship_date`，
	- 新增對應之 `E_StoreHouseStock_SC`（至少一筆）且 `IsApproved == 'N'`，
	- 交易成功時 commit，失敗時 rollback。

- **AC-002**: Given 購物車狀態（IsApproved='N'）的 SC 若干筆，When 呼叫 `StoreHouseStock_SC` POST（建立訂單），Then 每筆 SC 應被設定 `OrderGuid` 並更新 `IsApproved = 'Y'`，且能成功產生一筆或多筆 `E_StoreHouseStock_Order`。

- **AC-003**: Given 存在 SC 紀錄，When 呼叫 `Edit_SC` 並提供正確 `ssno` 與有效公司代號，Then 對應的 SC 應更新公司資訊並 `SaveChanges()`；若公司代號不存在，應回傳錯誤並不修改資料庫。

- **AC-004**: Given 呼叫 `Delete_SC` 或 `DeleteCar` 時，若目標紀錄不存在，API 不應拋出未處理例外；若存在，該紀錄應被刪除且 `SaveChanges()` 成功。

## 6. Test Automation Strategy

- Test Levels: Unit, Integration (DB in-memory 或測試資料庫)、End-to-End（必要時）。
- Frameworks: NUnit/xUnit + EntityFramework in-memory provider 或使用 SQL Server LocalDB for integration tests。
- Test Data Management:
	- 每個測試應建立並清理所需的 E_StoreHouseStock_SC / E_StoreHouseStock_BOS / E_StoreHouseStock_Order 測試紀錄。
- CI/CD Integration: 在 PR pipeline 中執行 Integration tests，驗證新增/更新/刪除流程在測試 DB 上可正常執行且交易行為正確。

## 7. Rationale & Context

- `E_StoreHouseStock_SC` 扮演「預計出貨明細」的角色：部分來自使用者手動確認（編輯 SC）、部分來自已銷單庫存（BOS）自動產生。將不同來源的記錄統一為 SC 可利於後續出貨流程的統一處理與匯出。
- 使用交易可避免在中間失敗時產生不一致狀態（例如 BOS 扣帳成功但 SC 新增失敗）。

## 8. Dependencies & External Integrations

### External Systems
- **EXT-001**: E_StoreHouseStock_BOS - 已銷單庫存來源。

### Third-Party Services
- **SVC-001**: Email Service - 在某些流程（如預計直出）會有通知需求，但不直接影響 SC 寫入流程。

### Infrastructure Dependencies
- **INF-001**: SQL Server - 作為系統主要資料庫，支援交易與 ACID。

### Data Dependencies
- **DAT-001**: E_ZRSD19 / E_ZRSD14P - 新增成倉庫存（非 SC）時會查詢這些表以取得機種/訂單資訊。

## 9. Examples & Edge Cases

範例：BOS_toShip 新增 SC 範例物件

```csharp
new E_StoreHouseStock_SC {
	exp_shipdate = "2025-11-13",
	eng_sr = "MODEL-ABC",
	exp_shipquantity = 10,
	stock_quantity = 50,
	position = "A01",
	transportation = "快遞",
	IsApproved = "N",
	sales_order = "N/A",
	cust_wono = "N/A",
	wono = "無工單出貨"
}
```

Edge cases:
- 若 `ship_quantity` 大於 BOS 的可用數量，系統應允許提交但以業務規則決定是否拒絕，或在 UI 顯示警示。
- 若多個使用者同時針對同一 BOS 進行出貨，必須確保交易鎖定或重試機制以避免超扣（optimistic concurrency 可考慮）。

## 10. Validation Criteria

- 程式單元測試覆蓋新增/修改/刪除的主要分支（成功、欄位驗證失敗、目標紀錄不存在、交易失敗回滾）。
- Integration 測試需驗證：BOS_toShip 成功會新增 SC 與更新 BOS；OrderConfirm 會將 SC 設為 IsApproved='Y' 並新增 E_StoreHouseStock_Order。

## 11. Related Specifications / Further Reading

- `spec/已銷單庫存-已銷出貨.md`
- `WebStoreHouse/Controllers/FunctionController.cs`（寫入/更新 SC 的實作位置）

---

**DISCLAIMER**: 本文件由 GitHub Copilot 協助產生，可能包含錯誤或遺漏，請人工審閱。

