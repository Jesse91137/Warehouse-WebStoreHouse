---
title: StoreHouse Dropshipping 操作規格
version: 1.0
date_created: 2025-11-13
last_updated: 2025-11-13
owner: Warehouse Team
tags: [process, dropshipping, spec]
---

## 簡介

本文件描述 `StoreHouseDropshipping` 的操作邏輯、資料合約、錯誤處理與驗收準則。目標是定義一套可被系統與第三方商家/供應商整合的明確流程，確保訂單從下單到出貨、追蹤與退件的整體可靠性與可觀察性。

## 1. 目的與範圍

- 目的：定義直出（dropshipping）流程在倉儲系統中的觸發條件、業務規則、API 介面與例外處理，讓前端商店或第三方系統能安全、可重入且可追蹤地委託倉庫直接出貨。
- 範圍：包含商品同步、庫存查詢、訂單接收、出貨排程、物流選擇、追蹤回報、取消/退貨與稽核日誌。此規格不討論前端 UI 的顯示細節，但涵蓋所有系統間的介面契約與驗收條件。

## 2. 定義

- Dropshipping / 直出：倉庫（StoreHouse）接收第三方電商或平台的訂單，倉庫直接從現有庫存或指定供應商出貨到最終買家地址。
- Seller / 商家：提出訂單或同步商品資訊的一方。
- Supplier / 供應商：若適用，倉庫會請供應商代發貨時的對接方。
- Fulfillment / 履行：倉庫執行從撿貨、包裝到交付物流的整個流程。
- OOS：Out of Stock，缺貨。

## 3. 需求、限制與指引

- REQ-001: 接收訂單：系統必須提供 API 允許商家投送直出訂單，並回傳接受/拒絕回應（含錯誤原因）。
- REQ-002: 庫存核對：在接收訂單時須對 SKU 與數量做即時庫存檢查，若不足須回報可用庫存或建議替代處理（等待進貨、部分出貨或取消）。
- REQ-003: 價格與運費：商家需帶入單品售價與運費策略標識，系統需保存該筆訂單的價格快照以供對帳。
- REQ-004: Idempotency：訂單接收 API 必須支援冪等機制（例如 Idempotency-Key）以避免重複建立訂單。
- REQ-005: 出貨排程：系統需能依優先順序（付款狀態、緊急標記、倉別）建立出貨作業並回傳工作單號。
- REQ-006: 物流選擇：依規則（目的地、重量、時效、成本）自動選擇物流，並能被覆寫。
- REQ-007: 追蹤與回報：出貨後須回傳物流追蹤號與運送狀態更新 API。
- REQ-008: 取消/退貨：支援出貨前取消、出貨中取消（退回流程）及買家退貨的接收與處理流程。
- REQ-009: 安全性：所有 API 必須透過 TLS，並採用 API Key 或 OAuth2/JWT 做授權驗證與存取稽核。
- REQ-010: 日誌與稽核：所有關鍵事件（接收訂單、庫存變更、派單、出貨、取消、退貨）必須紀錄不可變更的稽核紀錄（含時間、人、來源系統、前後狀態）。
- CON-001: 延遲限制：在高峰時段，庫存與出貨回應應在 5 秒內完成（若需呼叫供應商或第三方服務則以 15 秒為上限，並以非同步處理後補回報）。
- GUD-001: 若 SKU 類型複雜（組合/套裝），請在訂單明細中明確標記組成成分及其 SKU。

## 4. 介面與資料合約

以下列出核心 REST API 與 JSON 範例（建議使用 application/json）：

1) 接收訂單 - POST /api/dropship/orders

Request (示例):

```json
{
  "idempotencyKey": "string",
  "externalOrderId": "SHOP-12345",
  "orderDate": "2025-11-13T10:15:30Z",
  "buyer": {
    "name": "王小明",
    "phone": "+886912345678"
  },
  "shippingAddress": {
    "line1": "台北市中正區和平東路1段1號",
    "city": "台北市",
    "country": "TW",
    "postalCode": "100"
  },
  "items": [
    { "sku": "SKU-001", "quantity": 2, "unitPrice": 499.0 }
  ],
  "shippingMethod": "STANDARD",
  "notes": "直出，請使用環保包材",
  "metadata": { "channel": "shopify", "merchantId": "M-88" }
}
```

Response (示例成功):

```json
{
	"status": "ACCEPTED",
	"orderId": "WH-ORD-20251113-0001",
	"message": "Accepted and scheduled",
	"suggestedAction": null
}
```

Response (缺貨/部分出貨):

```json
{
	"status": "PARTIAL",
	"orderId": "WH-ORD-20251113-0002",
	"message": "Partial fulfillable",
	"unavailableItems": [{"sku":"SKU-002","requested":3,"available":1}]
}
```

2) 查詢庫存 - GET /api/dropship/inventory?sku=SKU-001

Response:

```json
{ "sku": "SKU-001", "availableQuantity": 12, "warehouseId": "WH-A" }
```

3) 回報出貨 - POST /api/dropship/shipments

Request:

```json
{
	"orderId": "WH-ORD-20251113-0001",
	"shipmentId": "SHIP-0001",
	"carrier": "T-Courier",
	"trackingNumber": "TRK123456789",
	"shippedAt": "2025-11-14T08:00:00Z",
	"items": [{"sku":"SKU-001","quantity":2}]
}
```

Response:

```json
{ "status": "OK", "message": "Shipment recorded" }
```

4) 取消訂單 - POST /api/dropship/orders/{orderId}/cancel

Request: { "reason": "buyer_request", "requestedBy": "merchant" }

Response: { "status":"CANCELLED","refundRequired": true }

5) Webhook / callback

- 建議提供 webhook 給商家，用於回報出貨、異常、退貨狀態變更。Webhook 必須支援簽章驗證（HMAC 或 JWT）。

## 5. 驗收準則 (Acceptance Criteria)

- AC-001: Given 已授權的商家，When POST 訂單至 /api/dropship/orders 並帶入合法 payload, Then 服務回傳 ACCEPTED 且 產生倉儲訂單號。
- AC-002: Given 訂單中某 SKU 庫存不足, When 接收訂單, Then 回傳 PARTIAL 並在回應中列出 unavailableItems。
- AC-003: Given 重複送出相同 Idempotency-Key, When 第一次成功建立訂單, Then 第二次不會建立重複訂單，會回傳既有訂單資訊。
- AC-004: Given 出貨完成, When POST /api/dropship/shipments, Then 商家可收到包含 trackingNumber 的成功回應，且系統產生日誌紀錄。
- AC-005: Given 商家註冊 webhook, When 出貨或退貨狀態變更, Then webhook 收到簽章驗證的事件通知。

## 6. 測試自動化策略

- 測試層級：Unit, Integration, End-to-End (E2E)
- 建議 Framework：.NET 專案使用 MSTest / xUnit、使用 Moq 做外部服務模擬；E2E 使用 Postman/Newman 或 Playwright 做 API 流程測試。
- 測試資料：建立固定的測試 SKU、模擬庫存、模擬第三方物流回調。測試應包含：成功建立、部分出貨、缺貨拒絕、重試/冪等性測試、取消與退貨流程。
- CI/CD：在 PR pipeline 中執行 unit + integration 測試；在主分支執行 E2E 測試及 contract tests（模擬商家端）。

## 7. 設計理由與上下文

- 為了避免商家因網路或重試邏輯導致重複訂單，我們強制 Idempotency-Key 與訂單快照保存，並以不可變的訂單快照（price snapshot）做對帳基準。
- 優先自動化物流選擇以降低人工錯誤，但允許商家在訂單或商店等級覆寫，以平衡商家控制權。

## 8. 相依性與外部整合

### 外部系統
- EXT-001: 物流供應商 API - 用於建立運單、取得追蹤狀態
- EXT-002: 供應商庫存 API（若倉庫需向供應商拉補貨或委託代發）

### 第三方服務
- SVC-001: 付款平台（僅保存付款狀態與時間，不直接處理退款）

### 基礎建設相依
- INF-001: 持久化資料庫（關鍵表：orders, order_items, inventory, shipments, audit_logs）
- INF-002: 隊列系統（例如 RabbitMQ 或 Azure Service Bus）用於非同步補貨查詢、出貨指令與 webhook 重試。

## 9. 範例與邊界情境

- 範例：部分出貨
	- 訂單 A 有 3 件 SKU-X，庫存僅 2 件 -> 回傳 PARTIAL，建立兩筆出貨作業，並在商家系統顯示剩餘待補貨數量。
- 邊界情境：物流延誤超過 SLA
	- 當運送狀態在預估送達日後超過 72 小時仍未更新，系統觸發異常告警並通知商家與客服。
- 邊界情境：地址錯誤導致退件
	- 若物流回報退件，系統標記為 RETURNED，觸發退貨處理流程，並根據商家策略進行退款或重新出貨。

## 10. 驗證標準

- 所有 API 必須通過 contract tests（模擬商家端）。
- Idempotency 測試：對同一 idempotencyKey 多次呼叫僅建立一筆訂單。
- 效能：庫存查詢在 95% 請求下回應時間 < 200ms（單服務環境）。

## 11. 相關規格 / 參考文件

- spec-inventory-management.md（庫存管理契約）
- spec-webhook-security.md（Webhook 與簽章規格）

---

**DISCLAIMER**: 本文件由 GitHub Copilot 本地化產生，可能含翻譯或格式問題。如發現不適當或錯誤，請建立 issue 以便修正。

