## StoreHouseStock_BOS 操作規格（已銷單庫存） 
- 資料來源
- 將[預計出貨]明細資料正式轉為訂單，將公司代號為[5]的資料寫入[已銷單庫存]（E_StoreHouseStock_BOS）



---
title: StoreHouseStock_BOS 操作規格（已銷單庫存）
version: 1.0
date_created: 2025-11-13
last_updated: 2025-11-13
owner: WebStoreHouse Team
tags: [storehouse, stock, inventory, BOS, specification]
---

# StoreHouseStock_BOS 操作規格（已銷單庫存）

以下為 `StoreHouseStock_BOS` 的詳細操作邏輯規格，我已把完整內容寫入本檔案，內容設計為機器可解析並可直接用於實作與測試。

## 1. 目的與適用範圍

本規格定義 `StoreHouseStock_BOS`（以下簡稱 BOS）的行為、資料契約、錯誤模式與驗收標準。BOS 的主要責任是管理「已銷單相關的庫存處理」，包含庫存保留（reservation）、扣減（commit）、釋放（release）、調整（adjust）與對帳（reconcile）。

適用範圍：WebStoreHouse 系統中所有與已銷單（已下單並進入出貨流程）有關的庫存變動，包含同步至倉儲子系統、記錄稽核資訊與提供查詢 API。

假設：系統使用 SQL / RDBMS 作為永續化儲存，採用 .NET (C#) 後端服務；但規格不綁定特定 ORM 或資料庫廠商。

## 2. 定義

- BOS: StoreHouseStock_BOS，負責已銷單相關庫存邏輯的服務/物件。
- Reservation: 因訂單而保留的庫存記錄（尚未實際出庫或完成扣減）。
- Commit: 將保留的庫存正式扣減至可用庫存（OnHand 減少，已出貨/已保留減少）。
- Release: 釋放先前的 Reservation（例如訂單取消或付款逾時），使可用庫存恢復。
- SKU / ItemId: 庫存項目識別。
- LocationId: 庫存所在儲位或倉別（可選，視系統支援情況）。
- Idempotency Key: 保證重入（重覆呼叫）安全的鍵值。

## 3. 需求、限制與指導原則

- **REQ-001**: 當接到保留請求時，BOS 必須檢查可用庫存是否足夠，若充足則建立 Reservation 並回傳 ReservationId；否則回傳明確錯誤 (InsufficientStock)。
- **REQ-002**: Commit 操作必須是可重入且具原子性；相同的 Commit 請求（以同一 OrderId + Idempotency Key）只能被處理一次。
- **REQ-003**: Release 操作需能釋放部分或全部 Reservation；Release 後該 Reservation 的狀態必須更新（例如：Released、PartiallyReleased）。
- **REQ-004**: 所有變更需產生審計日誌（Audit）包含：Actor、Action、OrderId、ItemId、數量差異、時間戳與原因。
- **REQ-005**: 面對平行請求（Concurrency），BOS 必須防止超賣（oversell）情況，並在高併發下保持資料一致性。
- **REQ-006**: 支援局部成功/失敗回滾策略：若 Commit 包含多個 SKU，若其中一 SKU 因庫存不足或鎖定失敗導致 Commit 失敗，系統需選擇性回滾已成功的部分或以 Transactional 批次方式一併失敗（具體策略由業務設定，預設為原子性全部失敗）。
- **REQ-007**: 提供查詢介面以取得當前 SKU 在指定 Location 的 OnHand、Available、Reserved 等數值。
- **CON-001**: 不在此服務內處理實際物流出貨（shipping）或財務請款流程；BOS 僅管理庫存數值及其狀態。
- **GUD-001**: 儘量以短交易（short transactions）與樂觀鎖（version/rowversion）或悲觀鎖（根據 DB 能力）來避免長時間鎖定。

## 4. 介面與資料契約

下面描述 BOS 提供的主要 API/方法與資料模型（示例使用 C# POCO 與 JSON schema 風格表示）。

資料模型：

```csharp
// 庫存項目狀態
public class StockItem
{
    public string ItemId { get; set; }
    public string LocationId { get; set; } // 可為 null
    public long OnHand { get; set; } // 實際在庫
    public long Reserved { get; set; } // 已被保留
    public long Available => OnHand - Reserved; // 可用數量
    public long Version { get; set; } // 樂觀鎖版本號
    public DateTime LastUpdated { get; set; }
}

public class ReservationItem
{
    public string ItemId { get; set; }
    public string LocationId { get; set; }
    public long Quantity { get; set; }
}

public class Reservation
{
    public string ReservationId { get; set; }
    public string OrderId { get; set; }
    public List<ReservationItem> Items { get; set; }
    public string Status { get; set; } // Pending, Committed, Released, PartiallyReleased
    public DateTime CreatedAt { get; set; }
}
```

主要介面（RPC/REST/Method）：

- ReserveStock(orderId, items[], idempotencyKey?) -> ReservationId | Error
  - 行為：檢查可用庫存；若足夠則建立 Reservation，並增加每項目的 Reserved 值；回傳 ReservationId。

- CommitReservation(reservationId, idempotencyKey?) -> Success | Error
  - 行為：把 Reservation 轉為正式扣減：OnHand 減去 Quantity，Reserved 減去 Quantity；標記 Reservation 為 Committed。

- ReleaseReservation(reservationId, items?) -> Success | Error
  - 行為：釋放 Reservation（可部分釋放），更新 Reserved 與 Reservation 狀態（Released / PartiallyReleased）。

- AdjustStock(itemId, locationId, delta, reason) -> Success | Error
  - 行為：手動或系統背景作業用於校正庫存（delta 可為正/負），並寫入稽核記錄。

- GetStock(itemId, locationId?) -> StockItem
  - 行為：查詢指定項目的即時庫存狀態（OnHand, Reserved, Available, Version）。

- ReconcileSnapshot(date) -> Report
  - 行為：產生指定日期點的庫存對帳報表，供人工或自動流程比對。

錯誤類型（範例）：

- InsufficientStock { ItemId, Needed, Available }
- ReservationNotFound
- ReservationAlreadyCommitted
- IdempotencyConflict
- ConcurrencyConflict

所有介面必須支援 Idempotency Key（呼叫者可選）以避免重覆處理。

## 5. 驗收準則（AC）

- **AC-001**: Given 系統有 OnHand=100, Reserved=0 for SKU=A; When 呼叫 ReserveStock(Order1, [A:10]); Then 返回 ReservationId 且 SKU=A 的 Reserved=10, Available=90。
- **AC-002**: Given ReservationId 對應 10 件 SKU=A 且狀態 Pending; When 呼叫 CommitReservation(ReservationId); Then SKU=A 的 OnHand 減少 10，Reserved 減少 10，Reservation 狀態為 Committed。
- **AC-003**: Given Reservation 已 Commit; When 重覆呼叫相同 Idempotency Key 的 CommitReservation，Then 不會再次扣減 OnHand（操作為幂等）。
- **AC-004**: Given Reservation Pending 且 Order 被取消; When 呼叫 ReleaseReservation(ReservationId); Then Reserved 減少相應數量，Available 恢復，Reservation 標記為 Released。
- **AC-005**: 在高併發情境下（1000 並發請求索取同一 SKU 的部分數量），系統不得導致 OnHand < 0（無超賣），並且能正確回傳失敗的請求為 InsufficientStock。

## 6. 自動化測試策略

- 單元測試：覆蓋核心邏輯（保留、提交、釋放、調整）使用 MSTest 或 xUnit，搭配 FluentAssertions、Moq 做外部依賴隔離。
- 整合測試：使用測試資料庫（可用 Docker 或 LocalDB），測試交易邊界、樂觀鎖與死鎖情形。
- 壓力測試：模擬高併發保留請求，確保無超賣，並衡量延遲和失敗率（工具：k6、JMeter）。

- 測試用例示例：
  - Happy path reserve -> commit
  - 重覆呼叫 reserve/commit 的 idempotency 行為
  - 部分釋放與部分 commit
  - 調整負數將觸發警告與審核紀錄

測試資料管理：每個整合測試應於開始時建立乾淨狀態（transaction rollback 或重新建立 schema）。

## 7. 設計理由與背景

- 原子性與幂等性是避免資料不一致與重覆出貨的核心需求。
- 保留-提交-釋放 模式可將訂單與實際出庫流程解耦，讓物流可以在獨立服務處理。
- 審計可追溯性提高營運與稽核需求的可觀察性。

## 8. 外部依賴與整合

### 外部系統

- **WMS（倉儲管理系統）**：用於同步實體倉出入（如需），BOS 應提供事件或呼叫端點供 WMS 拉取或接收推播。
- **Order Service**：BOS 會收到來自訂單服務的 Reserve/Commit/Release 呼叫；Order Service 為授權對象。

### 第三方服務

- **Message Broker / Event Bus**（建議）：當 Reservation 狀態改變時，發布事件（ReservationCreated, ReservationCommitted, ReservationReleased）給其他系統（WMS、Billing、Notification）。

### 基礎建設

- 資料庫需支援交易與樂觀鎖（RowVersion 或 Version 欄位）。
- 建議使用 Redis 或 RDBMS 的鎖機制在高併發時避免 race condition（配合回退重試）。

## 9. 範例與邊緣案例

 - 部分保留後部分 Commit：

```csharp
// Reserve 50 件 (OrderA)
var resId = bos.ReserveStock("OrderA", new[]{ new ReservationItem{ ItemId="SKU1", Quantity=50 }}, idempotencyKey: "r1");
// Commit only 30 件（部分出貨）
bos.CommitReservation(resId, items: new[]{ new ReservationItem{ ItemId="SKU1", Quantity=30 }});
// Expected: OnHand -= 30; Reserved -= 30; Reservation.Status == PartiallyCommitted
```

 - 併發競爭情況：多個客戶同時保留接近 OnHand 的總量，部分請求會收到 InsufficientStock。BOS 應以短鎖或行級鎖保證原子性並回傳正確錯誤。

 - Idempotency Key 缺失時：系統仍應作為無狀態呼叫處理，但呼叫端建議提供 idempotency key 以避免重覆處理。

## 10. 驗證標準

- 所有 AC 必須有對應的自動化測試且在 CI pipeline 上綠色通過。
- 壓力測試報告顯示在預期最高併發下無超賣情況並且系統可接受的錯誤率與延遲。

## 11. 相關規格與延伸閱讀

- `spec-warehouse-events.md`（倉儲事件總覽）
- `spec-order-lifecycle.md`（訂單生命週期與狀態機）

---

**注意事項**: 本檔案為機器可解析的操作規格草案。若有特定 DB/消息中介或業務偏好（例如允許部分提交成功而不回滾），請回覆以便我把對應策略納入 REQ/AC。

